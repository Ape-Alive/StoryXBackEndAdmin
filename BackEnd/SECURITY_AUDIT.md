# 安全审计报告 - AI调用授权系统

## 发现的漏洞和问题

### 🔴 严重问题

#### 1. **价格计算服务中套餐过期判断不一致**
**位置**: `src/services/priceCalculator.service.js:14-20`

**问题描述**:
- `getModelPriceForUser` 方法只查询 `expiresAt > new Date()` 的套餐
- 没有包含 `expiresAt = null`（永久套餐）
- 但在 `authorization.service.js` 中查询用户套餐时包含了永久套餐
- 这会导致永久套餐的价格无法被找到，导致授权申请失败

**影响**: 用户无法使用永久套餐申请授权

**修复方案**: 需要修改查询条件，包含永久套餐

---

#### 2. **取消授权方法未使用事务**
**位置**: `src/services/authorization.service.js:275-338`

**问题描述**:
- `cancelAuthorization` 方法中，释放额度和更新授权状态不在同一个事务中
- 如果释放额度成功但更新授权状态失败，会导致额度被释放但授权仍显示为active
- 或者相反，授权状态更新但额度未释放

**影响**: 数据不一致，可能导致额度丢失或重复使用

**修复方案**: 将释放额度和更新授权状态放在同一个事务中

---

#### 3. **并发请求可能导致额度超支**
**位置**: `src/services/authorization.service.js:170-210`

**问题描述**:
- 在检查可用额度和实际冻结额度之间存在时间窗口
- 多个并发请求可能同时通过额度检查，导致总冻结额度超过可用额度
- 虽然使用了事务，但事务开始前已经查询了额度，存在竞态条件

**影响**: 可能导致额度超支，用户可以使用超过其额度的服务

**修复方案**: 
- 在事务内重新查询并锁定额度记录
- 使用数据库锁（SELECT FOR UPDATE）确保原子性

---

#### 4. **授权过期后预冻结额度未自动释放**
**位置**: 整个系统

**问题描述**:
- 授权过期后（10分钟），如果用户没有调用AI服务，预冻结的额度不会被释放
- 没有定时任务清理过期授权
- 用户可能因为忘记调用而永久损失额度

**影响**: 用户额度可能被长期占用，影响使用体验

**修复方案**: 
- 创建定时任务清理过期授权并释放额度
- 或者在每次授权检查时自动清理过期授权

---

### 🟡 中等问题

#### 5. **上报调用结果时缺少对已使用授权的检查**
**位置**: `src/services/aiCall.service.js:13-37`

**问题描述**:
- 虽然检查了授权状态是否为active，但没有检查授权是否已经被使用过
- 如果授权状态是active但已经有requestId，应该拒绝重复上报
- 当前只检查了requestId是否已存在，但如果授权被重复使用，可能绕过检查

**影响**: 可能导致重复结算或数据不一致

**修复方案**: 检查授权是否已有requestId，如果有则拒绝上报

---

#### 6. **额度结算逻辑中，如果实际费用为0可能有问题**
**位置**: `src/services/aiCall.service.js:172-210`

**问题描述**:
- 如果调用成功但实际费用为0（比如按调用次数计价但价格为0），预冻结的额度可能没有完全释放
- 代码逻辑中，只有当 `status === 'success' && actualCost > 0` 时才会将预冻结转为已使用
- 如果 `actualCost === 0`，预冻结的额度不会被处理

**影响**: 可能导致额度被错误占用

**修复方案**: 需要处理 `actualCost === 0` 的情况，释放所有预冻结额度

---

#### 7. **价格计算时没有考虑套餐过期时间**
**位置**: `src/services/priceCalculator.service.js:12-27`

**问题描述**:
- `getModelPriceForUser` 查询用户套餐时，只检查了 `expiresAt > new Date()`
- 但没有检查套餐的 `startedAt`，可能查询到未开始的套餐
- 也没有检查套餐的 `isActive` 状态

**影响**: 可能使用错误的套餐价格

**修复方案**: 添加 `startedAt` 和套餐状态的检查

---

#### 8. **设备指纹验证缺失**
**位置**: `src/services/authorization.service.js:75`

**问题描述**:
- 申请授权时接收了 `deviceFingerprint`，但没有验证其格式或有效性
- 没有检查设备是否被禁用
- 没有记录或更新设备信息

**影响**: 可能被恶意用户利用，使用无效或禁用的设备申请授权

**修复方案**: 添加设备验证逻辑

---

### 🟢 轻微问题

#### 9. **缺少对模型价格的缓存**
**位置**: `src/services/priceCalculator.service.js`

**问题描述**:
- 每次计算费用都要查询数据库，没有缓存机制
- 高并发情况下可能造成数据库压力

**影响**: 性能问题，但不影响功能正确性

**修复方案**: 添加Redis缓存（可选）

---

#### 10. **错误信息可能泄露敏感信息**
**位置**: 多个服务文件

**问题描述**:
- 某些错误信息可能包含内部实现细节
- 例如：`Model price not found` 可能泄露模型配置信息

**影响**: 信息泄露风险

**修复方案**: 统一错误信息格式，避免泄露内部信息

---

## 修复优先级

1. **P0 (立即修复)**:
   - 问题1: 价格计算服务中套餐过期判断不一致
   - 问题2: 取消授权方法未使用事务
   - 问题3: 并发请求可能导致额度超支

2. **P1 (尽快修复)**:
   - 问题4: 授权过期后预冻结额度未自动释放
   - 问题5: 上报调用结果时缺少对已使用授权的检查
   - 问题6: 额度结算逻辑中，如果实际费用为0可能有问题

3. **P2 (计划修复)**:
   - 问题7: 价格计算时没有考虑套餐过期时间
   - 问题8: 设备指纹验证缺失

4. **P3 (优化)**:
   - 问题9: 缺少对模型价格的缓存
   - 问题10: 错误信息可能泄露敏感信息
