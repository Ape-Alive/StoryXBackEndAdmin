# 支付功能快速启动指南

## 一、前置准备

### 1. 安装依赖

```bash
cd BackEnd
npm install
```

新增依赖：`axios`

### 2. 配置环境变量

在 `BackEnd/.env` 文件中添加：

```env
# 订单配置
ORDER_EXPIRE_MINUTES=30

# YunGouOS 支付配置
YUNGOUOS_MCH_ID=your_mch_id
YUNGOUOS_API_KEY=your_api_key
YUNGOUOS_API_BASE_URL=https://api.pay.yungouos.com
# 注意：生产环境回调地址要求：
# 1. 必须公网可访问
# 2. 仅支持 http/https 协议
# 3. 不可包含端口（必须使用标准端口 80/443）
# 4. 不能包含参数
# 5. 只能是已备案的域名
# 开发环境可以使用 localhost（需要内网穿透）
YUNGOUOS_NOTIFY_URL=http://localhost:5800/api/payment/callback/yungouos
YUNGOUOS_RETURN_URL=http://localhost:3001/payment/return

# API 基础地址
API_BASE_URL=http://localhost:5800
```

### 3. 数据库迁移

```bash
cd BackEnd
npx prisma migrate dev --name add_order_and_payment
# 或
npx prisma db push
```

### 4. 重新生成 Prisma Client

```bash
cd BackEnd
npx prisma generate
```

## 二、启动服务

```bash
cd BackEnd
npm run dev
```

## 三、测试流程

### 1. 创建订单

```bash
curl -X POST http://localhost:5800/api/user/orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "packageId": "package_id_here",
    "type": "purchase"
  }'
```

响应示例：
```json
{
  "success": true,
  "message": "Order created successfully",
  "data": {
    "id": "order_id",
    "orderNo": "ORDER1234567890123",
    "status": "pending",
    "amount": "99.00",
    "finalAmount": "99.00",
    "expiresAt": "2024-01-28T19:00:00.000Z"
  }
}
```

### 2. 发起支付

```bash
curl -X POST http://localhost:5800/api/user/orders/ORDER_ID/payment \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "paymentMethod": "wxpay_native",
    "type": "2"
  }'
```

响应示例：
```json
{
  "success": true,
  "message": "Payment created successfully",
  "data": {
    "id": "payment_id",
    "paymentNo": "PAY1234567890123",
    "status": "pending",
    "qrCodeUrl": "http://images.yungouos.com/wxpay/native/code/xxx.png",
    "amount": "99.00"
  }
}
```

### 3. 模拟支付回调（测试）

```bash
curl -X POST http://localhost:5800/api/payment/callback/yungouos \
  -H "Content-Type: application/json" \
  -d '{
    "out_trade_no": "ORDER1234567890123",
    "total_fee": "99.00",
    "status": "success",
    "transaction_id": "WX_TRANSACTION_ID",
    "sign": "CALCULATED_SIGN"
  }'
```

**注意**：实际回调需要 YunGouOS 服务器调用，这里只是测试格式。

### 4. 查询订单状态

```bash
curl -X GET http://localhost:5800/api/user/orders/ORDER_ID \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 5. 查询支付状态

```bash
curl -X POST http://localhost:5800/api/user/payments/PAYMENT_ID/query \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 四、Swagger 文档

访问 `http://localhost:5800/api-docs` 查看完整的 API 文档。

## 五、常见问题

### 1. 支付回调签名验证失败

- 检查 `YUNGOUOS_API_KEY` 是否正确
- 确认签名算法与 YunGouOS 文档一致
- 查看日志了解详细错误信息

### 2. 订单创建失败

- 确认套餐存在且可用
- 确认套餐类型为 `paid`（免费套餐不能创建订单）
- 检查用户是否存在

### 3. 支付创建失败

- 检查 YunGouOS 配置是否正确
- 确认订单状态为 `pending`
- 查看日志了解详细错误信息

## 六、生产环境注意事项

1. **回调地址**：必须使用 HTTPS 和公网可访问的地址
2. **签名密钥**：妥善保管 `YUNGOUOS_API_KEY`，不要泄露
3. **订单过期**：建议设置定时任务定期清理过期订单
4. **日志记录**：所有支付操作都记录日志，便于排查问题
5. **错误处理**：做好异常情况的处理和用户提示

