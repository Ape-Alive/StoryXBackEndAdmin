# 额度管理接口拆分说明

## 概述

额度管理接口已拆分为**管理员接口**和**终端用户接口**两部分，明确区分使用场景和权限。

---

## 一、管理员接口（`/api/quotas`）

### 使用对象
- 后台管理员（super_admin, platform_admin, finance, read_only 等角色）

### 功能特点
- 可以查询**所有终端用户**的额度
- 可以管理**任意终端用户**的额度（调整、冻结、解冻、设置、重置等）
- 支持批量操作
- 支持统计和导出功能

### 接口列表

#### 1. 查询接口
- `GET /api/quotas` - 获取额度列表（支持筛选所有用户）
- `GET /api/quotas/users/{userId}` - 获取指定用户的所有额度
- `GET /api/quotas/users/{userId}/detail` - 获取指定用户的额度详情
- `GET /api/quotas/statistics` - 获取额度统计信息
- `GET /api/quotas/usage/trend` - 获取使用趋势统计（可筛选用户）
- `GET /api/quotas/usage/package-ranking` - 获取套餐使用排行
- `GET /api/quotas/usage/user-ranking` - 获取用户使用排行
- `GET /api/quotas/usage/distribution` - 获取使用分布统计
- `GET /api/quotas/users/{userId}/usage` - 获取指定用户的详细使用统计

#### 2. 管理接口
- `PATCH /api/quotas/users/{userId}/adjust` - 手动调整额度
- `PATCH /api/quotas/{id}/freeze` - 冻结额度
- `PATCH /api/quotas/{id}/unfreeze` - 解冻额度
- `PUT /api/quotas/{id}` - 设置额度
- `POST /api/quotas/{id}/reset` - 重置额度
- `PATCH /api/quotas/batch/adjust` - 批量调整额度
- `PATCH /api/quotas/batch/freeze` - 批量冻结额度
- `PATCH /api/quotas/batch/unfreeze` - 批量解冻额度

#### 3. 导出接口
- `POST /api/quotas/export` - 导出额度数据

### 权限要求
- **查询接口**：super_admin, platform_admin, finance, read_only
- **管理接口**：super_admin, platform_admin
- **导出接口**：super_admin, platform_admin, finance

---

## 二、终端用户接口（`/api/user/quotas`）

### 使用对象
- 终端用户（C端用户，role: user 或 basic_user）

### 功能特点
- **只能查询自己的额度**
- **不能修改额度**（额度调整由管理员操作）
- 自动从 JWT token 中获取用户ID，无需传递 userId 参数
- 提供查询、统计、趋势分析等功能

### 接口列表

#### 1. 查询接口
- `GET /api/user/quotas` - 获取我的额度列表
- `GET /api/user/quotas/detail` - 获取我的额度详情（可指定套餐）
- `GET /api/user/quotas/usage` - 获取我的使用统计
- `GET /api/user/quotas/usage/trend` - 获取我的使用趋势
- `GET /api/user/quotas/records` - 获取我的额度流水

### 权限要求
- 所有接口都需要认证（authenticate）
- 自动验证用户身份，确保只能查询自己的数据

### 安全机制
- 所有接口自动从 `req.user.id` 获取当前登录用户的ID
- 强制使用当前用户的ID进行查询，忽略任何传入的 userId 参数
- 如果 token 中没有用户ID，返回 401 错误

---

## 三、接口对比

| 功能 | 管理员接口 | 终端用户接口 |
|------|-----------|-------------|
| **路径前缀** | `/api/quotas` | `/api/user/quotas` |
| **查询范围** | 所有用户 | 仅自己 |
| **用户ID来源** | 路径参数或查询参数 | JWT token（自动） |
| **修改权限** | ✅ 支持 | ❌ 不支持 |
| **批量操作** | ✅ 支持 | ❌ 不支持 |
| **统计功能** | ✅ 完整统计 | ✅ 个人统计 |
| **导出功能** | ✅ 支持 | ❌ 不支持 |

---

## 四、使用示例

### 管理员查询用户额度
```bash
# 查询所有额度
GET /api/quotas?page=1&pageSize=20

# 查询指定用户的额度
GET /api/quotas/users/clx123456789

# 查询指定用户的额度详情
GET /api/quotas/users/clx123456789/detail?packageId=clx987654321
```

### 终端用户查询自己的额度
```bash
# 查询我的额度列表（无需传递 userId）
GET /api/user/quotas

# 查询我的额度详情
GET /api/user/quotas/detail?packageId=clx987654321

# 查询我的使用统计
GET /api/user/quotas/usage

# 查询我的使用趋势
GET /api/user/quotas/usage/trend?period=day

# 查询我的额度流水
GET /api/user/quotas/records?type=decrease
```

---

## 五、Swagger 文档

### 管理员接口
- **Tag**: `额度管理（管理员）`
- **Summary**: 所有接口都标注了 `[管理员]` 标识

### 终端用户接口
- **Tag**: `终端用户额度管理`
- **Summary**: 所有接口都标注了 `[仅终端用户]` 标识

访问 Swagger UI (`http://localhost:5800/api-docs`) 可以查看完整的接口文档。

---

## 六、注意事项

1. **用户ID获取**：
   - 管理员接口：通过路径参数或查询参数传递 `userId`
   - 终端用户接口：自动从 JWT token 的 `req.user.id` 获取

2. **权限验证**：
   - 管理员接口：使用 `authorize` 中间件验证角色权限
   - 终端用户接口：使用 `authenticate` 中间件验证登录状态，自动限制只能查询自己的数据

3. **数据安全**：
   - 终端用户接口强制使用当前登录用户的ID，即使传入其他 userId 也会被忽略
   - 所有终端用户接口都会验证 token 中是否包含用户ID

4. **接口路径**：
   - 管理员接口：`/api/quotas/*`
   - 终端用户接口：`/api/user/quotas/*`
   - 注意区分路径前缀，避免混淆

---

## 七、迁移指南

### 如果之前使用管理员接口查询自己的额度
**旧方式**（管理员接口）：
```bash
GET /api/quotas/users/{userId}
```

**新方式**（终端用户接口）：
```bash
GET /api/user/quotas
```

### 如果之前使用管理员接口查询自己的使用统计
**旧方式**（管理员接口）：
```bash
GET /api/quotas/users/{userId}/usage
```

**新方式**（终端用户接口）：
```bash
GET /api/user/quotas/usage
```

---

## 八、相关文件

- **管理员路由**: `BackEnd/src/routes/quota.routes.js`
- **终端用户路由**: `BackEnd/src/routes/userQuota.routes.js`
- **控制器**: `BackEnd/src/controllers/quota.controller.js`
- **服务层**: `BackEnd/src/services/quota.service.js`
- **路由注册**: `BackEnd/app.js`
