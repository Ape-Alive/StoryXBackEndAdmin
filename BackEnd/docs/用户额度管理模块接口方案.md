# 用户额度管理模块接口方案

## 重要说明：用户类型区分

### 用户类型
- **系统用户（Admin）**：后台管理员，登录后台管理系统，**不需要额度管理**
- **终端用户（User）**：C端用户，使用AI服务，**需要额度管理**

### 额度管理范围
- ✅ **仅针对终端用户（User）**：所有额度管理接口中的 `userId` 必须是终端用户ID
- ❌ **不针对系统用户（Admin）**：系统用户（管理员）不参与额度管理

### 数据模型关系
- `UserQuota` 模型关联的是 `User` 模型（终端用户）
- `UserQuota` 模型**不关联** `Admin` 模型（系统用户）
- 所有额度操作都基于终端用户（User）进行

---

## 一、现有接口分析

### 已实现的接口

1. **GET /api/quotas** - 获取额度列表
   - 支持分页和筛选（userId, packageId）
   - 权限：super_admin, platform_admin, finance, read_only

2. **GET /api/quotas/users/{userId}** - 获取用户的所有额度
   - 权限：super_admin, platform_admin, finance, read_only

3. **GET /api/quotas/users/{userId}/detail** - 获取用户额度详情
   - 支持 packageId 查询参数
   - 权限：super_admin, platform_admin, finance, read_only

4. **PATCH /api/quotas/users/{userId}/adjust** - 手动调整额度
   - 支持增加/减少额度
   - 权限：super_admin, platform_admin

### 已实现的 Repository 方法

- `findQuotas` - 查询额度列表
- `findByUserAndPackage` - 根据用户和套餐查询
- `findByUser` - 查询用户的所有额度
- `upsertQuota` - 创建或更新额度
- `freezeQuota` - 冻结额度（内部方法）
- `unfreezeQuota` - 解冻额度（内部方法）
- `deductQuota` - 扣减额度（内部方法）
- `increaseQuota` - 增加额度（内部方法）

---

## 二、缺少的接口（需要新增）

### 1. 冻结/解冻额度接口

**PATCH /api/quotas/{id}/freeze**
- 功能：管理员手动冻结**终端用户**额度
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "amount": 100.00,
    "reason": "违规操作，冻结额度"
  }
  ```
- 逻辑：
  - 验证额度是否存在
  - **验证额度关联的用户是终端用户（User），不是系统用户（Admin）**
  - 检查可用额度是否足够
  - 将可用额度转移到冻结额度
  - 记录额度流水（type: freeze）
  - 记录操作日志（记录操作的管理员ID）

**PATCH /api/quotas/{id}/unfreeze**
- 功能：管理员手动解冻**终端用户**额度
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "amount": 100.00,
    "reason": "问题已解决，解冻额度"
  }
  ```
- 逻辑：
  - 验证额度是否存在
  - **验证额度关联的用户是终端用户（User），不是系统用户（Admin）**
  - 检查冻结额度是否足够
  - 将冻结额度转移到可用额度
  - 记录额度流水（type: unfreeze）
  - 记录操作日志（记录操作的管理员ID）

### 2. 设置额度接口

**PUT /api/quotas/{id}**
- 功能：管理员直接设置**终端用户**额度（覆盖现有值）
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "available": 1000.00,
    "frozen": 0.00,
    "used": 0.00,
    "reason": "重置用户额度"
  }
  ```
- 逻辑：
  - 验证额度是否存在
  - **验证额度关联的用户是终端用户（User），不是系统用户（Admin）**
  - 计算变动量（before -> after）
  - 更新额度值
  - 记录额度流水（根据变动类型：increase/decrease）
  - 记录操作日志（记录操作的管理员ID）

### 3. 批量调整额度接口

**PATCH /api/quotas/batch/adjust**
- 功能：批量调整多个**终端用户**的额度
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "items": [
      {
        "quotaId": "clx123",
        "amount": 100.00,
        "reason": "批量充值"
      },
      {
        "quotaId": "clx456",
        "amount": -50.00,
        "reason": "批量扣减"
      }
    ]
  }
  ```
- 逻辑：
  - 使用事务处理批量操作
  - **验证每个额度关联的用户都是终端用户（User）**
  - 逐个处理每个额度调整
  - 记录每条额度流水
  - 记录操作日志（记录操作的管理员ID）
  - 返回成功和失败的列表

### 4. 批量冻结/解冻接口

**PATCH /api/quotas/batch/freeze**
- 功能：批量冻结多个**终端用户**的额度
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "items": [
      {
        "quotaId": "clx123",
        "amount": 100.00,
        "reason": "批量冻结"
      }
    ]
  }
  ```
- 逻辑：
  - **验证每个额度关联的用户都是终端用户（User）**

**PATCH /api/quotas/batch/unfreeze**
- 功能：批量解冻多个**终端用户**的额度
- 权限：super_admin, platform_admin（系统用户）
- 逻辑：
  - **验证每个额度关联的用户都是终端用户（User）**

### 5. 导出额度数据接口

**POST /api/quotas/export**
- 功能：导出**终端用户**额度数据为 Excel/CSV
- 权限：super_admin, platform_admin, finance（系统用户）
- 请求体：
  ```json
  {
    "userId": "clx123",
    "packageId": "clx456",
    "format": "excel"
  }
  ```
- 逻辑：
  - 根据筛选条件查询额度数据（仅查询终端用户）
  - 包含用户信息、套餐信息、额度详情
  - 生成 Excel/CSV 文件
  - 返回文件下载链接或直接返回文件流

### 6. 额度统计接口

**GET /api/quotas/statistics**
- 功能：获取**终端用户**额度统计信息
- 权限：super_admin, platform_admin, finance, read_only（系统用户）
- 查询参数：
  - userId（可选）：统计指定终端用户的额度
  - packageId（可选）：统计指定套餐的额度
- 返回数据：
  ```json
  {
    "totalAvailable": 100000.00,
    "totalFrozen": 5000.00,
    "totalUsed": 20000.00,
    "totalQuota": 125000.00,
    "terminalUserCount": 100,  // 终端用户数量
    "packageCount": 10
  }
  ```
- 逻辑：
  - **仅统计终端用户（User）的额度，不包括系统用户（Admin）**

### 7. 重置额度接口

**POST /api/quotas/{id}/reset**
- 功能：重置**终端用户**额度（清零）
- 权限：super_admin, platform_admin（系统用户）
- 请求体：
  ```json
  {
    "reason": "用户违规，重置额度"
  }
  ```
- 逻辑：
  - 验证额度是否存在
  - **验证额度关联的用户是终端用户（User），不是系统用户（Admin）**
  - 记录重置前的额度值
  - 将所有额度字段设置为 0
  - 记录额度流水（type: decrease）
  - 记录操作日志（记录操作的管理员ID）

---

## 三、实现逻辑设计

### 1. 额度操作通用流程

```
1. 验证权限（确保是管理员操作）
2. 验证用户类型（确保 userId 是终端用户，不是系统用户）
3. 验证额度是否存在
4. 验证操作合法性（如：冻结时检查可用额度是否足够）
5. 使用数据库事务确保数据一致性
6. 更新额度数据
7. 记录额度流水（QuotaRecord）
8. 记录操作日志（OperationLog，记录操作的管理员信息）
9. 返回结果
```

### 1.1 用户类型验证逻辑

**必须验证 userId 是终端用户（User），不是系统用户（Admin）**

```javascript
// 在 Service 层添加验证方法
async function validateTerminalUser(userId) {
  const user = await prisma.user.findUnique({
    where: { id: userId }
  });

  if (!user) {
    throw new NotFoundError('Terminal user not found');
  }

  // 确保不是系统用户（虽然 User 和 Admin 是不同的表，但需要明确验证）
  // User 表的用户才是终端用户
  return user;
}
```

### 2. 额度流水记录规则

- **increase**: 增加可用额度
- **decrease**: 减少可用额度
- **freeze**: 从可用额度转移到冻结额度
- **unfreeze**: 从冻结额度转移到可用额度
- **reset**: 重置额度（清零）

### 3. 事务处理

所有涉及额度变动的操作都应使用数据库事务：
- 确保额度更新和流水记录的一致性
- 防止并发操作导致的数据不一致
- 批量操作时，一个失败则全部回滚

### 4. 权限控制

- **操作者**：系统用户（Admin）- 后台管理员
- **被操作者**：终端用户（User）- C端用户
- **查询权限**：super_admin, platform_admin, finance, read_only（系统用户）
- **操作权限**：super_admin, platform_admin（系统用户）
- **导出权限**：super_admin, platform_admin, finance（系统用户）

### 5. 用户类型验证规则

**所有接口必须验证**：
1. 操作者是系统用户（Admin）- 通过 JWT Token 验证
2. 被操作者是终端用户（User）- 通过 userId 查询 User 表验证
3. 额度记录关联的用户必须是终端用户（User）

**验证失败处理**：
- 如果 userId 不存在于 User 表 → 返回 404 "Terminal user not found"
- 如果额度记录关联的用户不是终端用户 → 返回 400 "Invalid user type"

---

## 四、需要新增的文件

### 1. Service 层扩展

在 `BackEnd/src/services/quota.service.js` 中新增方法：
- `validateTerminalUser` - 验证用户是终端用户（私有方法）
- `freezeQuota` - 冻结额度（终端用户）
- `unfreezeQuota` - 解冻额度（终端用户）
- `setQuota` - 设置额度（终端用户）
- `batchAdjustQuota` - 批量调整额度（终端用户）
- `batchFreezeQuota` - 批量冻结额度（终端用户）
- `batchUnfreezeQuota` - 批量解冻额度（终端用户）
- `resetQuota` - 重置额度（终端用户）
- `getQuotaStatistics` - 获取统计信息（终端用户）
- `exportQuotas` - 导出额度数据（终端用户）

**注意**：所有方法都需要先调用 `validateTerminalUser` 验证用户类型

### 2. Controller 层扩展

在 `BackEnd/src/controllers/quota.controller.js` 中新增方法：
- `freezeQuota` - 冻结额度控制器
- `unfreezeQuota` - 解冻额度控制器
- `setQuota` - 设置额度控制器
- `batchAdjustQuota` - 批量调整额度控制器
- `batchFreezeQuota` - 批量冻结额度控制器
- `batchUnfreezeQuota` - 批量解冻额度控制器
- `resetQuota` - 重置额度控制器
- `getQuotaStatistics` - 获取统计信息控制器
- `exportQuotas` - 导出额度数据控制器

### 3. Validator 层新增

创建 `BackEnd/src/validators/quota.validator.js`：
- `freezeQuotaValidator` - 冻结额度验证
- `unfreezeQuotaValidator` - 解冻额度验证
- `setQuotaValidator` - 设置额度验证
- `batchAdjustQuotaValidator` - 批量调整验证
- `batchFreezeQuotaValidator` - 批量冻结验证

### 4. Routes 层扩展

在 `BackEnd/src/routes/quota.routes.js` 中新增路由：
- `PATCH /api/quotas/:id/freeze`
- `PATCH /api/quotas/:id/unfreeze`
- `PUT /api/quotas/:id`
- `POST /api/quotas/:id/reset`
- `PATCH /api/quotas/batch/adjust`
- `PATCH /api/quotas/batch/freeze`
- `PATCH /api/quotas/batch/unfreeze`
- `GET /api/quotas/statistics`
- `POST /api/quotas/export`

---

## 五、数据库操作注意事项

### 1. 并发控制

使用 Prisma 的 `update` 操作时，应该：
- 使用 `increment`/`decrement` 原子操作
- 或者使用事务 + 行锁

### 2. 数据一致性

- 确保 `available + frozen + used` 的逻辑一致性
- 冻结操作：`available` 减少，`frozen` 增加
- 解冻操作：`frozen` 减少，`available` 增加
- 扣减操作：`frozen` 减少，`used` 增加

### 3. 额度流水记录

每次额度变动都必须记录：
- 变动类型（type）
- 变动金额（amount）
- 变动前后额度（before, after）
- 变动原因（reason）
- 操作人信息（通过 adminId 关联）

---

## 六、实现优先级建议

### 高优先级（核心功能）
1. ✅ 冻结/解冻额度接口
2. ✅ 设置额度接口
3. ✅ 额度统计接口

### 中优先级（批量操作）
4. ✅ 批量调整额度接口
5. ✅ 批量冻结/解冻接口

### 低优先级（辅助功能）
6. ✅ 导出额度数据接口
7. ✅ 重置额度接口

---

## 七、接口权限总结

| 接口 | 查询权限 | 操作权限 | 导出权限 |
|------|---------|---------|---------|
| 获取额度列表 | ✅ | - | - |
| 获取用户额度 | ✅ | - | - |
| 调整额度 | - | ✅ | - |
| 冻结/解冻额度 | - | ✅ | - |
| 设置额度 | - | ✅ | - |
| 批量操作 | - | ✅ | - |
| 统计信息 | ✅ | - | - |
| 导出数据 | - | - | ✅ |

**权限角色说明**：
- ✅ 查询权限：super_admin, platform_admin, finance, read_only（系统用户）
- ✅ 操作权限：super_admin, platform_admin（系统用户）
- ✅ 导出权限：super_admin, platform_admin, finance（系统用户）

---

## 八、用户类型验证实现示例

### Service 层验证方法

```javascript
// 在 quota.service.js 中添加
async validateTerminalUser(userId) {
  const user = await prisma.user.findUnique({
    where: { id: userId }
  });

  if (!user) {
    throw new NotFoundError('Terminal user not found');
  }

  // User 表只包含终端用户，Admin 表包含系统用户
  // 如果能查询到 User 记录，说明是终端用户
  return user;
}

// 在额度操作前调用
async freezeQuota(quotaId, amount, reason, adminId, ipAddress) {
  // 1. 查询额度记录
  const quota = await quotaRepository.findById(quotaId);
  if (!quota) {
    throw new NotFoundError('Quota not found');
  }

  // 2. 验证用户类型（关键步骤）
  await this.validateTerminalUser(quota.userId);

  // 3. 执行冻结操作
  // ...
}
```

### Controller 层验证

```javascript
// 在 quota.controller.js 中
async freezeQuota(req, res, next) {
  try {
    const { id } = req.params;
    const { amount, reason } = req.body;

    // req.user 是系统用户（Admin），通过 JWT 认证
    // id 是额度ID，需要验证关联的用户是终端用户

    const quota = await quotaService.freezeQuota(
      id,
      amount,
      reason,
      req.user?.id,  // 操作者：系统用户（Admin）
      req.ip
    );

    return ResponseHandler.success(res, quota, 'Quota frozen successfully');
  } catch (error) {
    next(error);
  }
}
```

### 数据模型关系

```
Admin (系统用户)
  ├── 登录后台管理系统
  ├── 角色：super_admin, platform_admin, finance 等
  └── ❌ 不参与额度管理

User (终端用户)
  ├── 使用 AI 服务
  ├── 角色：basic_user, user
  └── ✅ 参与额度管理
      ├── UserQuota (用户额度)
      ├── QuotaRecord (额度流水)
      └── UserPackage (用户套餐)
```

---

## 九、关键注意事项

### 1. 用户类型验证
- ✅ **必须验证**：所有涉及 userId 的操作都要验证是终端用户（User）
- ✅ **验证方式**：通过查询 `prisma.user.findUnique` 验证用户存在
- ❌ **禁止操作**：系统用户（Admin）不能有额度记录

### 2. 操作日志记录
- 操作者：系统用户（Admin）- 从 `req.user.id` 获取
- 被操作者：终端用户（User）- 从额度记录的 `userId` 获取
- 操作日志中的 `adminId` 记录操作的管理员ID

### 3. 接口路径说明
- 所有接口路径中的 `userId` 都指终端用户ID
- 所有接口都需要系统用户（Admin）权限才能访问
- 接口文档中明确标注"终端用户"和"系统用户"
