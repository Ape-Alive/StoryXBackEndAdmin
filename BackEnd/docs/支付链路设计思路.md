# 支付链路设计思路

## 一、整体流程

```
用户下单 → 订单模块（生成订单，待支付）
    ↓
发起支付 → 支付模块（调用第三方支付接口）
    ↓
支付回调（成功）→ 流水模块（记账本）
    ↓
根据流水算结果 → 账户模块（余额/剩余额度）
    ↓
用户使用 → 每次使用再走一次「流水 → 账户」
```

## 二、现有模块分析

### ✅ 已存在的模块

1. **套餐模块（Package）**
   - ✅ `Package` 模型：套餐定义（价格、额度、有效期等）
   - ✅ `UserPackage` 模型：用户套餐关系
   - ✅ `userPackage.service.js`：套餐订阅逻辑（`subscribePackage`）
   - ⚠️ **问题**：`subscribePackage` 直接创建 `UserPackage`，没有经过订单和支付流程

2. **账户模块（UserQuota）**
   - ✅ `UserQuota` 模型：用户额度账户（available, frozen, used）
   - ✅ `quota.service.js`：额度调整逻辑（`adjustQuota`, `increaseQuota`, `deductQuota`）

3. **流水模块（QuotaRecord）**
   - ✅ `QuotaRecord` 模型：额度流水记录（increase, decrease, freeze, unfreeze）
   - ✅ `quotaRecord.repository.js`：流水查询逻辑

4. **使用扣费逻辑**
   - ✅ `quota.service.js`：扣减额度逻辑
   - ✅ `QuotaRecord`：记录每次使用产生的流水

### ❌ 缺失的模块

1. **订单模块（Order）** - 完全缺失
   - ❌ 没有 `Order` 模型
   - ❌ 没有订单相关的 repository, service, controller, routes
   - ❌ 没有订单状态管理（pending, paid, cancelled, refunded）

2. **支付模块（Payment）** - 完全缺失
   - ❌ 没有 `Payment` 或 `Transaction` 模型
   - ❌ 没有第三方支付对接逻辑（YunGouOS）
   - ❌ 没有支付回调处理逻辑
   - ❌ 没有支付流水记录

3. **支付流水模块（PaymentRecord）** - 缺失
   - ❌ 没有支付流水记录（与 `QuotaRecord` 区分）
   - ❌ 支付流水应该记录：支付金额、支付方式、支付状态、第三方交易号等

## 三、需要新增的数据模型

### 1. Order（订单）

```prisma
model Order {
  id              String   @id @default(cuid())
  orderNo         String   @unique // 订单号（全局唯一）
  userId          String
  packageId       String
  type            String   // purchase, renewal, upgrade
  status          String   @default("pending") // pending, paid, cancelled, refunded, expired
  amount          Decimal  @db.Decimal(20, 2) // 订单金额（元）
  currency        String   @default("CNY") // 货币单位
  discount        Decimal? @db.Decimal(5, 2) // 折扣（百分比）
  finalAmount     Decimal  @db.Decimal(20, 2) // 实付金额（元）
  description     String?  // 订单描述
  expiresAt       DateTime? // 订单过期时间
  paidAt          DateTime? // 支付时间
  cancelledAt     DateTime? // 取消时间
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  package         Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  payments        Payment[]
  quotaRecords    QuotaRecord[]

  @@index([userId])
  @@index([orderNo])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}
```

### 2. Payment（支付记录）

```prisma
model Payment {
  id              String   @id @default(cuid())
  orderId         String
  paymentNo       String   @unique // 支付单号（全局唯一）
  thirdPartyNo    String?  // 第三方支付交易号（YunGouOS 返回）
  paymentMethod   String   // wxpay_native, alipay, etc.
  amount          Decimal  @db.Decimal(20, 2) // 支付金额（元）
  currency        String   @default("CNY")
  status          String   @default("pending") // pending, success, failed, cancelled, refunded
  qrCodeUrl       String?  // 二维码地址（Native 支付）
  payUrl          String?  // 支付链接
  callbackData    String?  @db.Text // 回调数据（JSON）
  notifyUrl       String?  // 回调通知地址
  paidAt          DateTime? // 支付成功时间
  failedAt        DateTime? // 支付失败时间
  failureReason   String?  // 失败原因
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([paymentNo])
  @@index([thirdPartyNo])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}
```

### 3. PaymentRecord（支付流水）- 可选，如果 Payment 已足够详细可不用

```prisma
model PaymentRecord {
  id              String   @id @default(cuid())
  paymentId       String
  type            String   // payment, refund, adjustment
  amount          Decimal  @db.Decimal(20, 2)
  before          Decimal  @db.Decimal(20, 2) // 变动前金额
  after           Decimal  @db.Decimal(20, 2) // 变动后金额
  reason          String?
  thirdPartyData  String?  @db.Text // 第三方数据（JSON）
  createdAt       DateTime @default(now())

  payment         Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([type])
  @@index([createdAt])
  @@map("payment_records")
}
```

### 4. 需要修改的模型

#### User 模型需要添加关联

```prisma
model User {
  // ... 现有字段
  orders          Order[]  // 新增
  payments        Payment[] // 如果 Payment 直接关联 User，否则不需要
}
```

#### Package 模型需要添加关联

```prisma
model Package {
  // ... 现有字段
  orders          Order[]  // 新增
}
```

#### QuotaRecord 模型需要添加关联

```prisma
model QuotaRecord {
  // ... 现有字段
  orderId         String?  // 新增：关联订单（如果是购买套餐产生的额度增加）
  order           Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([orderId]) // 新增索引
}
```

## 四、需要新增的业务逻辑

### 1. 订单模块（Order）

#### Repository 层
- `order.repository.js`
  - `create(data)` - 创建订单
  - `findById(id)` - 根据ID查询
  - `findByOrderNo(orderNo)` - 根据订单号查询
  - `findByUserId(userId, filters, pagination)` - 查询用户订单列表
  - `updateStatus(id, status, data)` - 更新订单状态
  - `findExpiredOrders()` - 查询过期订单

#### Service 层
- `order.service.js`
  - `createOrder(userId, packageId, type)` - 创建订单
    - 计算订单金额（考虑折扣）
    - 生成订单号（全局唯一）
    - 设置订单过期时间（如30分钟）
  - `getOrderDetail(orderId, userId)` - 获取订单详情
  - `getUserOrders(userId, filters, pagination)` - 获取用户订单列表
  - `cancelOrder(orderId, userId)` - 取消订单
  - `expireOrder(orderId)` - 订单过期处理
  - `completeOrder(orderId)` - 完成订单（支付成功后调用）

#### Controller 层
- `order.controller.js`
  - `POST /api/user/orders` - 创建订单
  - `GET /api/user/orders` - 获取我的订单列表
  - `GET /api/user/orders/:id` - 获取订单详情
  - `POST /api/user/orders/:id/cancel` - 取消订单
  - `GET /api/orders` - 管理员查询订单列表（需要权限）
  - `GET /api/orders/:id` - 管理员查询订单详情

#### Routes
- `order.routes.js` - 定义订单相关路由

### 2. 支付模块（Payment）

#### Repository 层
- `payment.repository.js`
  - `create(data)` - 创建支付记录
  - `findById(id)` - 根据ID查询
  - `findByPaymentNo(paymentNo)` - 根据支付单号查询
  - `findByOrderId(orderId)` - 根据订单ID查询
  - `findByThirdPartyNo(thirdPartyNo)` - 根据第三方交易号查询
  - `updateStatus(id, status, data)` - 更新支付状态

#### Service 层
- `payment.service.js`
  - `createPayment(orderId, paymentMethod)` - 创建支付
    - 调用 YunGouOS 接口创建支付订单
    - 生成支付单号
    - 保存支付记录
  - `getPaymentDetail(paymentId, userId)` - 获取支付详情
  - `handlePaymentCallback(data)` - 处理支付回调
    - 验证签名
    - 更新支付状态
    - 更新订单状态
    - 触发订单完成逻辑
  - `queryPaymentStatus(paymentId)` - 查询支付状态（主动查询）

#### 第三方支付对接
- `services/payment/yungouos.service.js`
  - `createNativePayment(orderData)` - 创建微信扫码支付
    - 调用 `POST https://api.pay.yungouos.com/api/pay/wxpay/nativePay`
    - 处理返回结果
  - `verifyCallback(data, sign)` - 验证回调签名
  - `queryPaymentStatus(thirdPartyNo)` - 查询支付状态

#### Controller 层
- `payment.controller.js`
  - `POST /api/user/orders/:orderId/payment` - 发起支付
  - `GET /api/user/payments/:id` - 获取支付详情
  - `POST /api/payment/callback/yungouos` - 支付回调接口（不需要认证）
  - `POST /api/user/payments/:id/query` - 主动查询支付状态

#### Routes
- `payment.routes.js` - 定义支付相关路由

### 3. 订单完成后的处理逻辑

#### 在 `payment.service.js` 的 `handlePaymentCallback` 中

```javascript
async handlePaymentCallback(callbackData) {
  // 1. 验证签名
  // 2. 更新支付状态
  // 3. 更新订单状态为 paid
  // 4. 调用订单完成逻辑
  await orderService.completeOrder(orderId);
}

// 在 order.service.js 中
async completeOrder(orderId) {
  // 1. 更新订单状态为 paid
  // 2. 创建或更新 UserPackage
  // 3. 初始化或增加 UserQuota（根据套餐额度）
  // 4. 记录 QuotaRecord（type: increase, reason: 订单支付成功）
}
```

### 4. 修改现有的 `userPackage.service.js`

#### 修改 `subscribePackage` 方法

**当前逻辑**：直接创建 `UserPackage`，没有经过订单和支付

**新逻辑**：
- 如果是免费套餐（`type === 'free'`）：可以直接创建 `UserPackage`
- 如果是付费套餐（`type === 'paid'`）：必须先创建订单，然后支付，支付成功后才创建 `UserPackage`

**或者**：
- 保留 `subscribePackage` 用于管理员手动分配或免费套餐
- 付费套餐必须走订单流程：`createOrder` → `createPayment` → `handlePaymentCallback` → `completeOrder`

## 五、接口清单

### 订单相关接口

1. **POST /api/user/orders** - 创建订单
   - 请求：`{ packageId, type }`
   - 响应：订单信息（包含订单号、金额、过期时间等）

2. **GET /api/user/orders** - 获取我的订单列表
   - 查询参数：`page, pageSize, status, type`
   - 响应：订单列表（分页）

3. **GET /api/user/orders/:id** - 获取订单详情
   - 响应：订单详情（包含关联的支付信息）

4. **POST /api/user/orders/:id/cancel** - 取消订单
   - 响应：取消结果

5. **GET /api/orders** - 管理员查询订单列表（需要权限）
   - 查询参数：`page, pageSize, userId, status, orderNo, startDate, endDate`
   - 响应：订单列表（分页）

6. **GET /api/orders/:id** - 管理员查询订单详情

### 支付相关接口

1. **POST /api/user/orders/:orderId/payment** - 发起支付
   - 请求：`{ paymentMethod: 'wxpay_native' }`
   - 响应：支付信息（包含二维码地址或支付链接）

2. **GET /api/user/payments/:id** - 获取支付详情
   - 响应：支付详情（包含支付状态、二维码地址等）

3. **POST /api/payment/callback/yungouos** - 支付回调接口（公开接口，不需要认证）
   - 请求：YunGouOS 回调数据
   - 响应：`success` 或 `fail`

4. **POST /api/user/payments/:id/query** - 主动查询支付状态
   - 响应：最新支付状态

## 六、关键业务流程

### 1. 用户购买套餐流程

```
1. 用户选择套餐 → POST /api/user/orders
   - 创建订单（status: pending）
   - 返回订单信息

2. 用户发起支付 → POST /api/user/orders/:orderId/payment
   - 创建支付记录（status: pending）
   - 调用 YunGouOS 接口
   - 返回二维码地址

3. 用户扫码支付
   - 前端轮询支付状态或等待回调

4. YunGouOS 回调 → POST /api/payment/callback/yungouos
   - 验证签名
   - 更新支付状态（success）
   - 更新订单状态（paid）
   - 创建 UserPackage
   - 初始化 UserQuota
   - 记录 QuotaRecord（type: increase）

5. 前端收到支付成功通知
   - 刷新订单状态
   - 跳转到成功页面
```

### 2. 用户使用额度流程（已存在，但需要确认）

```
1. 用户调用 AI 模型
   - 预冻结额度（Authorization.frozenQuota）

2. 调用成功
   - 扣减额度（UserQuota.available 减少，used 增加）
   - 记录 QuotaRecord（type: decrease）
   - 更新 Authorization（status: used）

3. 调用失败
   - 解冻额度（UserQuota.frozen 减少，available 增加）
   - 记录 QuotaRecord（type: unfreeze）
```

## 七、需要修改的现有代码

### 1. `userPackage.service.js`

- **`subscribePackage` 方法**：需要判断套餐类型
  - 免费套餐：直接创建 `UserPackage`
  - 付费套餐：抛出错误，提示用户先创建订单

### 2. `quota.service.js`

- **`increaseQuota` 方法**：需要支持关联订单ID
  - 在 `QuotaRecord` 中记录 `orderId`

### 3. `schema.prisma`

- 添加 `Order` 模型
- 添加 `Payment` 模型
- 修改 `User` 模型，添加 `orders` 关联
- 修改 `Package` 模型，添加 `orders` 关联
- 修改 `QuotaRecord` 模型，添加 `orderId` 字段

## 八、环境变量配置

需要在 `.env` 中添加：

```env
# YunGouOS 支付配置
YUNGOUOS_MCH_ID=your_mch_id
YUNGOUOS_API_KEY=your_api_key
YUNGOUOS_NOTIFY_URL=https://your-domain.com/api/payment/callback/yungouos
YUNGOUOS_RETURN_URL=https://your-domain.com/payment/return

# 订单配置
ORDER_EXPIRE_MINUTES=30 # 订单过期时间（分钟）
```

## 九、待实现的功能点

1. ✅ 订单创建逻辑
2. ✅ 订单状态管理
3. ✅ 订单过期处理（定时任务）
4. ✅ YunGouOS 支付对接
5. ✅ 支付回调处理
6. ✅ 支付签名验证
7. ✅ 订单完成后的套餐分配逻辑
8. ✅ 支付流水记录
9. ✅ 订单查询接口（用户端和管理端）
10. ✅ 支付状态查询接口

## 十、注意事项

1. **幂等性**：支付回调可能重复通知，需要做幂等处理
2. **签名验证**：必须验证 YunGouOS 回调的签名，防止伪造
3. **订单过期**：需要定时任务清理过期订单
4. **事务处理**：订单完成后的多个操作（更新订单、创建套餐、增加额度）需要在事务中执行
5. **错误处理**：支付失败、订单取消等异常情况的处理
6. **日志记录**：所有支付相关操作都需要记录日志，便于排查问题

