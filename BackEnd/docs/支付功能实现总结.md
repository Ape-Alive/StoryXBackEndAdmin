# 支付功能实现总结

## 一、已完成功能

### 1. 数据库模型

✅ **Order（订单）模型**
- 订单号、用户ID、套餐ID
- 订单类型（purchase, renewal, upgrade）
- 订单状态（pending, paid, cancelled, refunded, expired）
- 订单金额、折扣、实付金额
- 订单过期时间、支付时间、取消时间

✅ **Payment（支付记录）模型**
- 支付单号、订单ID、第三方交易号
- 支付方式（wxpay_native, alipay等）
- 支付平台（yungouos, wechat_official, alipay_official, stripe）
- 支付状态（pending, success, failed, cancelled, refunded）
- 二维码地址、支付链接、回调数据

✅ **QuotaRecord（额度流水）增强**
- 添加 `orderId` 字段，关联订单

### 2. 支付平台架构（可扩展设计）

✅ **支付平台抽象层**
- `PaymentProvider` 基类：定义统一接口
- `PaymentFactory` 工厂类：根据平台名称创建提供者实例
- 支持多平台扩展：yungouos, wechat_official, alipay_official, stripe

✅ **YunGouOS 支付对接**
- 实现 `YunGouOSProvider` 类
- 支持微信扫码支付（Native 支付）
- 签名生成和验证
- 回调数据处理

### 3. 订单模块

✅ **Repository 层**
- `order.repository.js`：订单数据访问
- 订单创建、查询、更新、状态管理
- 过期订单查询

✅ **Service 层**
- `order.service.js`：订单业务逻辑
- 创建订单（计算金额、折扣、过期时间）
- 订单详情查询
- 订单取消
- 订单完成（支付成功后创建 UserPackage 和增加额度）
- 过期订单处理

✅ **Controller 层**
- `order.controller.js`：订单接口控制器

✅ **Routes 和 Validators**
- `order.routes.js`：订单路由定义（含 Swagger 文档）
- `order.validator.js`：订单参数验证

### 4. 支付模块

✅ **Repository 层**
- `payment.repository.js`：支付记录数据访问
- 支付创建、查询、更新、状态管理

✅ **Service 层**
- `payment.service.js`：支付业务逻辑
- 创建支付（调用第三方支付接口）
- 支付详情查询
- 支付回调处理（验证签名、更新状态、完成订单）
- 支付状态查询

✅ **Controller 层**
- `payment.controller.js`：支付接口控制器

✅ **Routes 和 Validators**
- `payment.routes.js`：支付路由定义（含 Swagger 文档）
- `paymentCallback.routes.js`：支付回调路由（公开接口）
- `payment.validator.js`：支付参数验证

### 5. 业务逻辑修改

✅ **userPackage.service.js**
- `subscribePackage` 方法：付费套餐必须走订单流程
- 免费套餐可以直接订阅

### 6. 环境变量配置

✅ **env.example**
- 订单配置：`ORDER_EXPIRE_MINUTES`
- YunGouOS 支付配置
- 其他支付平台配置（预留）

## 二、API 接口清单

### 订单接口

1. **POST /api/user/orders** - 创建订单
   - 需要认证
   - 请求体：`{ packageId, type? }`
   - 响应：订单信息

2. **GET /api/user/orders** - 获取我的订单列表
   - 需要认证
   - 查询参数：`page, pageSize, status, type, orderNo`
   - 响应：订单列表（分页）

3. **GET /api/user/orders/:id** - 获取订单详情
   - 需要认证
   - 响应：订单详情（含支付信息）

4. **POST /api/user/orders/:id/cancel** - 取消订单
   - 需要认证
   - 响应：取消结果

5. **GET /api/orders/admin** - 管理员查询订单列表
   - 需要认证 + 权限（super_admin, platform_admin, finance, operator）
   - 查询参数：`page, pageSize, userId, status, orderNo, startDate, endDate`
   - 响应：订单列表（分页）

6. **GET /api/orders/admin/:id** - 管理员查询订单详情
   - 需要认证 + 权限

### 支付接口

1. **POST /api/user/orders/:orderId/payment** - 发起支付
   - 需要认证
   - 请求体：`{ paymentMethod, type?, notifyUrl?, returnUrl? }`
   - 响应：支付信息（含二维码地址或支付链接）

2. **GET /api/user/payments/:id** - 获取支付详情
   - 需要认证
   - 响应：支付详情

3. **POST /api/payment/callback/:platform** - 支付回调接口
   - **公开接口，不需要认证**
   - 支持平台：yungouos, wechat_official, alipay_official, stripe
   - 请求体：支付平台回调数据（可能是 JSON 或 form-urlencoded）
   - 响应：根据平台返回不同格式（YunGouOS 返回 'success' 或 'fail'）

4. **POST /api/user/payments/:id/query** - 查询支付状态
   - 需要认证
   - 响应：最新支付状态

## 三、完整支付流程

```
1. 用户选择套餐
   ↓
2. POST /api/user/orders
   - 创建订单（status: pending）
   - 计算订单金额（考虑折扣）
   - 设置订单过期时间（默认30分钟）
   ↓
3. POST /api/user/orders/:orderId/payment
   - 创建支付记录（status: pending）
   - 调用 YunGouOS 接口创建支付
   - 返回二维码地址或支付链接
   ↓
4. 前端展示二维码
   - 用户使用微信扫码支付
   ↓
5. YunGouOS 回调 → POST /api/payment/callback/yungouos
   - 验证签名
   - 更新支付状态（success）
   - 更新订单状态（paid）
   - 创建 UserPackage
   - 初始化 UserQuota
   - 记录 QuotaRecord（type: increase, orderId: xxx）
   ↓
6. 前端收到支付成功通知
   - 刷新订单状态
   - 跳转到成功页面
```

## 四、关键特性

### 1. 可扩展的支付平台架构

- **抽象基类**：`PaymentProvider` 定义统一接口
- **工厂模式**：`PaymentFactory` 根据平台名称创建实例
- **易于扩展**：新增支付平台只需：
  1. 创建新的 Provider 类（继承 `PaymentProvider`）
  2. 在 `PaymentFactory` 中添加 case
  3. 更新 `getSupportedPlatforms()` 方法

### 2. 安全性

- **签名验证**：支付回调必须验证签名
- **幂等性处理**：防止重复处理回调
- **事务保证**：订单完成操作在事务中执行

### 3. 错误处理

- **订单过期**：支持定时任务清理过期订单
- **支付失败**：记录失败原因
- **回调异常**：即使处理失败也返回适当响应给支付平台

## 五、环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 订单配置
ORDER_EXPIRE_MINUTES=30

# YunGouOS 支付配置
YUNGOUOS_MCH_ID=your_mch_id
YUNGOUOS_API_KEY=your_api_key
YUNGOUOS_API_BASE_URL=https://api.pay.yungouos.com
YUNGOUOS_NOTIFY_URL=https://your-domain.com/api/payment/callback/yungouos
YUNGOUOS_RETURN_URL=https://your-domain.com/payment/return

# API 基础地址（用于生成回调地址）
API_BASE_URL=https://your-domain.com
```

## 六、数据库迁移

运行以下命令更新数据库：

```bash
cd BackEnd
npx prisma migrate dev --name add_order_and_payment
# 或
npx prisma db push
```

## 七、安装依赖

```bash
cd BackEnd
npm install
```

新增依赖：
- `axios`: 用于调用第三方支付 API

## 八、后续扩展

### 添加新的支付平台

1. **创建 Provider 类**
   ```javascript
   // BackEnd/src/services/payment/providers/wechat-official.provider.js
   const PaymentProvider = require('./base.provider');

   class WeChatOfficialProvider extends PaymentProvider {
     async createPayment(orderData) { /* ... */ }
     async verifyCallback(callbackData, sign) { /* ... */ }
     async queryPaymentStatus(thirdPartyNo) { /* ... */ }
     parseCallback(callbackData) { /* ... */ }
     getPlatformName() { return 'wechat_official'; }
   }
   ```

2. **在 PaymentFactory 中注册**
   ```javascript
   case 'wechat_official':
     return new WeChatOfficialProvider(config);
   ```

3. **更新环境变量**
   ```env
   WECHAT_APP_ID=your_app_id
   WECHAT_MCH_ID=your_mch_id
   WECHAT_API_KEY=your_api_key
   ```

## 九、注意事项

1. **YunGouOS 回调格式**：实际回调数据格式可能需要根据 YunGouOS 实际返回调整 `parseCallback` 方法
2. **签名算法**：YunGouOS 使用 MD5 签名，其他平台可能使用不同的算法
3. **订单过期**：建议设置定时任务定期清理过期订单
4. **支付回调**：必须做好幂等性处理，防止重复处理
5. **错误日志**：所有支付相关操作都记录日志，便于排查问题

## 十、测试建议

1. **订单创建**：测试不同套餐类型的订单创建
2. **支付创建**：测试支付创建和二维码生成
3. **支付回调**：模拟 YunGouOS 回调，测试签名验证和订单完成逻辑
4. **订单取消**：测试订单取消功能
5. **订单过期**：测试订单过期处理

