# 额度使用情况查询接口说明

## 一、现有接口（已实现）

### 1. 查询用户当前额度余额

#### GET /api/quotas/users/{userId}
获取用户的所有额度记录

**权限**: super_admin, platform_admin, finance, read_only

**示例**:
```bash
GET /api/quotas/users/clx123456789
```

**响应**:
```json
{
  "success": true,
  "message": "User quotas retrieved successfully",
  "data": [
    {
      "id": "quota_id",
      "userId": "clx123456789",
      "packageId": "package_id",
      "available": "1000.00",
      "frozen": "0.00",
      "used": "500.00",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "user": {
        "id": "clx123456789",
        "email": "user@example.com",
        "phone": "13800138000",
        "status": "active"
      }
    }
  ]
}
```

#### GET /api/quotas/users/{userId}/detail?packageId=xxx
获取用户指定套餐的额度详情

**权限**: super_admin, platform_admin, finance, read_only

**示例**:
```bash
GET /api/quotas/users/clx123456789/detail?packageId=clx987654321
```

### 2. 查询额度流水记录

#### GET /api/quota-records
获取额度流水列表，支持多条件筛选

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `userId` - 用户ID（可选）
- `packageId` - 套餐ID（可选）
- `type` - 流水类型：`increase`（增加）、`decrease`（减少/使用）、`freeze`（冻结）、`unfreeze`（解冻）
- `startDate` - 开始时间（ISO 8601格式）
- `endDate` - 结束时间（ISO 8601格式）
- `orderId` - 订单ID（可选）
- `requestId` - 请求ID（可选）
- `page` - 页码（默认1）
- `pageSize` - 每页数量（默认20）

**示例**:
```bash
# 查询用户的所有使用记录（减少类型）
GET /api/quota-records?userId=clx123456789&type=decrease

# 查询用户最近30天的使用情况
GET /api/quota-records?userId=clx123456789&startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z

# 查询用户指定套餐的使用记录
GET /api/quota-records?userId=clx123456789&packageId=clx987654321&type=decrease
```

### 3. 查询额度统计信息

#### GET /api/quotas/statistics
获取额度统计信息

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `userId` - 用户ID（可选）
- `packageId` - 套餐ID（可选）

**示例**:
```bash
GET /api/quotas/statistics?userId=clx123456789
```

**响应**:
```json
{
  "success": true,
  "message": "Quota statistics retrieved successfully",
  "data": {
    "totalAvailable": 100000.00,
    "totalFrozen": 5000.00,
    "totalUsed": 20000.00,
    "totalQuota": 125000.00,
    "terminalUserCount": 100,
    "packageCount": 10
  }
}
```

---

## 二、新增详细统计接口

### 1. 使用趋势统计

#### GET /api/quotas/usage/trend
按时间段统计额度使用趋势（支持按日/周/月统计）

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `userId` - 终端用户ID（可选）
- `packageId` - 套餐ID（可选）
- `startDate` - 开始时间（ISO 8601格式，可选）
- `endDate` - 结束时间（ISO 8601格式，可选）
- `period` - 时间段类型：`day`（按日）、`week`（按周）、`month`（按月），默认 `day`

**示例**:
```bash
# 按日统计最近30天的使用趋势
GET /api/quotas/usage/trend?startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z&period=day

# 按月统计使用趋势
GET /api/quotas/usage/trend?period=month

# 查询指定用户的使用趋势
GET /api/quotas/usage/trend?userId=clx123456789&period=day
```

**响应**:
```json
{
  "success": true,
  "message": "Usage trend retrieved successfully",
  "data": [
    {
      "period": "2024-01-01",
      "totalAmount": 100.50,
      "totalCount": 5
    },
    {
      "period": "2024-01-02",
      "totalAmount": 200.75,
      "totalCount": 8
    }
  ]
}
```

### 2. 套餐使用排行

#### GET /api/quotas/usage/package-ranking
统计套餐使用排行（按使用额度排序）

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `startDate` - 开始时间（ISO 8601格式，可选）
- `endDate` - 结束时间（ISO 8601格式，可选）
- `limit` - 返回数量限制（默认10，最大100）

**示例**:
```bash
# 获取最近30天的套餐使用排行
GET /api/quotas/usage/package-ranking?startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z&limit=10
```

**响应**:
```json
{
  "success": true,
  "message": "Package ranking retrieved successfully",
  "data": [
    {
      "packageId": "clx987654321",
      "package": {
        "id": "clx987654321",
        "name": "premium",
        "displayName": "高级套餐"
      },
      "totalAmount": 5000.00,
      "totalCount": 100
    },
    {
      "packageId": "clx111222333",
      "package": {
        "id": "clx111222333",
        "name": "basic",
        "displayName": "基础套餐"
      },
      "totalAmount": 3000.00,
      "totalCount": 200
    }
  ]
}
```

### 3. 用户使用排行

#### GET /api/quotas/usage/user-ranking
统计终端用户使用排行（按使用额度排序）

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `startDate` - 开始时间（ISO 8601格式，可选）
- `endDate` - 结束时间（ISO 8601格式，可选）
- `limit` - 返回数量限制（默认10，最大100）

**示例**:
```bash
# 获取最近30天的用户使用排行
GET /api/quotas/usage/user-ranking?startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z&limit=10
```

**响应**:
```json
{
  "success": true,
  "message": "User ranking retrieved successfully",
  "data": [
    {
      "userId": "clx123456789",
      "user": {
        "id": "clx123456789",
        "email": "user1@example.com",
        "phone": "13800138000"
      },
      "totalAmount": 1000.00,
      "totalCount": 50
    },
    {
      "userId": "clx987654321",
      "user": {
        "id": "clx987654321",
        "email": "user2@example.com",
        "phone": "13900139000"
      },
      "totalAmount": 800.00,
      "totalCount": 40
    }
  ]
}
```

### 4. 使用分布统计

#### GET /api/quotas/usage/distribution
统计额度使用分布（按类型、时间段等）

**权限**: super_admin, platform_admin, finance, read_only

**查询参数**:
- `userId` - 终端用户ID（可选）
- `packageId` - 套餐ID（可选）
- `startDate` - 开始时间（ISO 8601格式，可选）
- `endDate` - 结束时间（ISO 8601格式，可选）

**示例**:
```bash
# 获取全局使用分布统计
GET /api/quotas/usage/distribution

# 获取指定用户的使用分布
GET /api/quotas/usage/distribution?userId=clx123456789
```

**响应**:
```json
{
  "success": true,
  "message": "Usage distribution retrieved successfully",
  "data": {
    "byType": [
      {
        "type": "increase",
        "totalAmount": 10000.00,
        "totalCount": 50
      },
      {
        "type": "decrease",
        "totalAmount": 5000.00,
        "totalCount": 200
      },
      {
        "type": "freeze",
        "totalAmount": 1000.00,
        "totalCount": 10
      },
      {
        "type": "unfreeze",
        "totalAmount": 500.00,
        "totalCount": 5
      }
    ],
    "byPeriod": {
      "today": {
        "totalAmount": 100.00,
        "totalCount": 5
      },
      "week": {
        "totalAmount": 700.00,
        "totalCount": 35
      },
      "month": {
        "totalAmount": 3000.00,
        "totalCount": 150
      },
      "year": {
        "totalAmount": 5000.00,
        "totalCount": 200
      }
    }
  }
}
```

### 5. 用户详细使用统计

#### GET /api/quotas/users/{userId}/usage
获取指定终端用户的详细使用统计

**权限**: super_admin, platform_admin, finance, read_only

**路径参数**:
- `userId` - 终端用户ID（必填）

**查询参数**:
- `startDate` - 开始时间（ISO 8601格式，可选）
- `endDate` - 结束时间（ISO 8601格式，可选）

**示例**:
```bash
# 获取用户详细使用统计
GET /api/quotas/users/clx123456789/usage

# 获取用户指定时间段的详细使用统计
GET /api/quotas/users/clx123456789/usage?startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z
```

**响应**:
```json
{
  "success": true,
  "message": "User usage statistics retrieved successfully",
  "data": {
    "total": {
      "totalAmount": 1000.00,
      "totalCount": 50
    },
    "byPackage": [
      {
        "packageId": "clx987654321",
        "package": {
          "id": "clx987654321",
          "name": "premium",
          "displayName": "高级套餐"
        },
        "totalAmount": 600.00,
        "totalCount": 30
      },
      {
        "packageId": "clx111222333",
        "package": {
          "id": "clx111222333",
          "name": "basic",
          "displayName": "基础套餐"
        },
        "totalAmount": 400.00,
        "totalCount": 20
      }
    ],
    "dailyUsage": [
      {
        "date": "2024-01-01",
        "amount": 50.00
      },
      {
        "date": "2024-01-02",
        "amount": 75.00
      }
    ]
  }
}
```

---

## 三、使用场景示例

### 场景1：查看用户当前额度余额
```bash
# 1. 获取用户的所有额度
GET /api/quotas/users/clx123456789

# 2. 获取用户指定套餐的额度详情
GET /api/quotas/users/clx123456789/detail?packageId=clx987654321
```

### 场景2：查看用户使用历史
```bash
# 1. 获取用户的所有使用记录
GET /api/quota-records?userId=clx123456789&type=decrease

# 2. 获取用户最近30天的使用情况
GET /api/quota-records?userId=clx123456789&startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z
```

### 场景3：分析使用趋势
```bash
# 1. 按日统计最近30天的使用趋势
GET /api/quotas/usage/trend?startDate=2024-01-01T00:00:00Z&endDate=2024-01-31T23:59:59Z&period=day

# 2. 按月统计使用趋势
GET /api/quotas/usage/trend?period=month
```

### 场景4：查看排行榜
```bash
# 1. 查看套餐使用排行
GET /api/quotas/usage/package-ranking?limit=10

# 2. 查看用户使用排行
GET /api/quotas/usage/user-ranking?limit=10
```

### 场景5：查看用户详细统计
```bash
# 获取用户详细使用统计（包括总体统计、按套餐统计、每日使用趋势）
GET /api/quotas/users/clx123456789/usage
```

---

## 四、注意事项

1. **用户类型限制**：所有接口中的 `userId` 必须是终端用户（User）ID，不能是系统用户（Admin）ID
2. **时间格式**：所有时间参数使用 ISO 8601 格式，例如：`2024-01-01T00:00:00Z`
3. **权限要求**：所有查询接口都需要认证，且需要相应的角色权限
4. **分页参数**：列表接口支持分页，默认每页20条，最大100条
5. **数据范围**：统计接口默认统计所有数据，可通过 `startDate` 和 `endDate` 限制时间范围

---

## 五、测试脚本

项目根目录提供了测试脚本 `test-quota-usage-apis.js`，使用方法：

1. 启动后端服务：`npm run dev`
2. 登录获取 token
3. 修改测试脚本中的 `TOKEN` 和 `userId`
4. 运行测试：`node test-quota-usage-apis.js`
